{% extends 'header.html' %}
{% load static %}
{% block content%}
    <style>
        body.sidebar-main-active.right-column-fixed .content-page, body.sidebar-main-active.right-column-fixed{
            margin-right: 0;
        }
        body.sidebar-main-active.right-column-fixed .iq-top-navbar {
            margin-right: 150px;
            /* width: calc(100% - 460px); */
        }
        body.sidebar-main-active.right-column-fixed .content-page, body.sidebar-main-active.right-column-fixed .iq-footer {
            margin-left: 80px;
            margin-right: 0;
        }
        #weather{
                background: #2980B9;
                background: -webkit-linear-gradient(to right, #FFFFFF, #6DD5FA, #81c4f1);
                background: linear-gradient(to right, #FFFFFF, #6DD5FA, #81c4f1);
                min-width: 400px;
        }
    </style>

<body class="sidebar-main-active right-column-fixed header-top-bgcolor">
      <!-- loader Start -->
      <div id="loading">
         <div id="loading-center">
         </div>
      </div>
      <!-- loader END -->
      <!-- Wrapper Start -->
      <div class="wrapper">
         <!-- Sidebar  -->
          {% include 'slide.html' %}
         <!-- TOP Nav Bar -->
          {% include 'top_navbar.html' %}
         <!-- TOP Nav Bar END -->
         <!-- Page Content  -->
         <div id="content-page" class="content-page">
            <div class="container-fluid">
               <div class="row">
                  <div class="col-sm-6 col-md-6 col-lg-2">
                     <div class="iq-card iq-card-block iq-card-stretch ">
                        <div class="iq-card-body">
                                <div class="d-flex d-flex align-items-center justify-content-between">
                                   <div>
                                       <h2>{% if nombre_vehicules %} {{nombre_vehicules}} {% else %} 0 {% endif %}</h2>
                                       <p class="fontsize-sm m-0">Nombre de voitures</p>
                                   </div>
                                   <div class="rounded-circle iq-card-icon dark-icon-light iq-bg-primary "> <i class="ri-roadster-line"></i></div>
                                </div>
                        </div>
                     </div>
                  </div>
                  <div class="col-sm-6 col-md-6 col-lg-2">
                     <div class="iq-card iq-card-block iq-card-stretch ">
                        
                        <div class="iq-card-body">
                           <div class="d-flex d-flex align-items-center justify-content-between">
                              <div>
                                  <h2>{% if nombre_conducteurs %} {{nombre_conducteurs}} {% else %} 0 {% endif %}</h2>
                                  <p class="fontsize-sm m-0">Nombre de conducteurs</p>
                              </div>
                              <div class="rounded-circle iq-card-icon iq-bg-secondary"><i class="ri-user-line"></i></div>
                           </div>
                         </div>
                     </div>
                  </div>
                  <div class="col-sm-6 col-md-6 col-lg-2">
                     <div class="iq-card iq-card-block iq-card-stretch ">
                        <div class="iq-card-body">
                           <div class="d-flex d-flex align-items-center justify-content-between">
                              <div>
                                  <h2>{% if nombre_incidents %} {{nombre_incidents}} {% else %} 0 {% endif %}</h2>
                                  <p class="fontsize-sm m-0">Nombre d'incidents</p>
                              </div>
                              <div class="rounded-circle iq-card-icon iq-bg-danger"><i class="ri-alert-line"></i></div>
                           </div>
                       </div>
                     </div>
                  </div>
                  <div class="col-sm-6 col-md-6 col-lg-2">
                     <div class="iq-card iq-card-block iq-card-stretch ">
                        <div class="iq-card-body">
                           <div class="d-flex d-flex align-items-center justify-content-between">
                              <div>
                                  <h2>{% if nombre_deplacements_en_cours %} {{nombre_deplacements_en_cours}} {% else %} 0 {% endif %}</h2>
                                  <p class="fontsize-sm m-0">Déplacements en cours</p>
                              </div>
                              <div class="rounded-circle iq-card-icon iq-bg-info "><i class="ri-send-plane-2-fill"></i></div>
                           </div>
                       </div>
                     </div>
                  </div>
                 <div class="col-sm-6 col-md-6 col-lg-2">
                     <div class="iq-card iq-card-block iq-card-stretch ">
                        <div class="iq-card-body">
                           <div class="d-flex d-flex align-items-center justify-content-between">
                              <div>
                                  <h2>{% if nombre_deplacement_en_attente %} {{nombre_deplacement_en_attente}} {% else %} 0 {% endif %}</h2>
                                  <p class="fontsize-sm m-0">Déplacements en attente</p>
                              </div>
                              <div class="rounded-circle iq-card-icon iq-bg-warning "><i class="fa fa-paper-plane"></i></div>
                           </div>
                       </div>
                     </div>
                  </div>
                   <div class="col-sm-6 col-md-6 col-lg-2">
                     <div class="iq-card iq-card-block iq-card-stretch ">
                        <div class="iq-card-body">
                           <div class="d-flex d-flex align-items-center justify-content-between">
                              <div>
                                  <h2>{% if nombre_deplacement_termine %} {{nombre_deplacement_termine}} {% else %} 0 {% endif %}   </h2>
                                  <p class="fontsize-sm m-0">Déplacements total</p>
                              </div>
                              <div class="rounded-circle iq-card-icon iq-bg-success "><i class="bi bi-send-check-fill"></i></div>
                           </div>
                       </div>
                     </div>
                  </div>
               </div>
               <div class="row">
                  <div class="col-md-6 col-lg-7">
                     <div class="iq-card iq-card-block iq-card-stretch iq-card-height overflow-hidden">
                        <div class="iq-card-header d-flex justify-content-between">
                           <div class="iq-header-title">
                              <h4 class="card-title">Résumé des véhicules</h4>
                           </div>
                           <div class="iq-card-header-toolbar d-flex align-items-center">
                              <div class="dropdown">
                                 <span class="dropdown-toggle" id="dropdownMenuButton" data-toggle="dropdown">
                                 <i class="ri-more-fill"></i>
                                 </span>
                                 <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenuButton" >
                                    <a class="dropdown-item" href="#"><i class="ri-eye-fill mr-2"></i>View</a>
                                    <a class="dropdown-item" href="#"><i class="ri-delete-bin-6-fill mr-2"></i>Delete</a>
                                    <a class="dropdown-item" href="#"><i class="ri-pencil-fill mr-2"></i>Edit</a>
                                    <a class="dropdown-item" href="#"><i class="ri-printer-fill mr-2"></i>Print</a>
                                    <a class="dropdown-item" href="#"><i class="ri-file-download-fill mr-2"></i>Download</a>
                                 </div>
                              </div>
                           </div>
                        </div>
                        <div class="iq-card-body">
                            <div class="table-responsive" id="vehicules-table">
                              <table class="table mb-0 table-borderless">
                                 <thead>
                                    <tr>
                                       <th scope="col">Marque</th>
                                       <th scope="col">Type commercial</th>
                                       <th scope="col">Numéro d'immatriculation</th>
                                       <th scope="col">Kilométrage</th>
                                        <th scope="col">Disponibilité</th>
                                    </tr>
                                 </thead>
                                 <tbody>
                                    {% for vehicule in vehicule_disponible %}
                                        <tr>
                                            <td>{{ vehicule.marque }}</td>
                                            <td>{{ vehicule.type_commercial }}</td>
                                            <td>{{ vehicule.numero_immatriculation }}</td>
                                            <td>{{ vehicule.kilometrage }}</td>
                                            <td class="text-center">
                                                <div class="badge badge-pill iq-bg-warning" style="font-size: medium">
                                                    Oui
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                 </tbody>
                              <!-- Ajoutez la pagination -->
                                <div class="pagination" id="pagination-links">
                                   <span class="step-links">
                                      {% if vehicule_disponible.has_previous %}
                                         <a href="?page=1">&laquo; 1</a>
                                         <a href="?page={{ vehicule_disponible.previous_page_number }}">Précédent</a>
                                      {% endif %}

                                      <span class="current">
                                          {{ vehicule_disponible.number }} sur {{ vehicule_disponible.paginator.num_pages }}.
                                      </span>

                                      {% if vehicule_disponible.has_next %}
                                         <a href="?page={{ vehicule_disponible.next_page_number }}">Suivant</a>
                                         <a href="?page={{ vehicule_disponible.paginator.num_pages }}">{{ vehicule_disponible.paginator.num_pages }} &raquo;</a>
                                      {% endif %}
                                   </span>
                                </div>
                              </table>
                           </div>
                        </div>
                     </div>
                  </div>
                  <div class="col-md-6 col-lg-5">
                     <div class="iq-card iq-card-block iq-card-stretch iq-card-height" style="background: transparent;">
                        <div class="iq-card-body rounded p-0" style="background: url({% static 'images/vehicul.jpg' %}) no-repeat;    background-size: cover; height: 415px;">
                          <div class="iq-caption">
                          </div>
                        </div>
                     </div>
                  </div>
               </div>
               <div class="row">
                  <div class="col-lg-8">
                     <div class="iq-card iq-card-block iq-card-stretch iq-card-height">
                        <div class="iq-card-header d-flex justify-content-between">
                           <div class="iq-header-title">
                              <h4 class="card-title">Déplacements récents</h4>
                           </div>
                           <div class="iq-card-header-toolbar d-flex align-items-center">
                              <div class="dropdown">
                                 <span class="dropdown-toggle text-primary" id="dropdownMenuButton5" data-toggle="dropdown">
                                 <i class="ri-more-fill"></i>
                                 </span>
                                 <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenuButton5">
                                    <a class="dropdown-item" href="#"><i class="ri-eye-fill mr-2"></i>View</a>
                                    <a class="dropdown-item" href="#"><i class="ri-delete-bin-6-fill mr-2"></i>Delete</a>
                                    <a class="dropdown-item" href="#"><i class="ri-pencil-fill mr-2"></i>Edit</a>
                                    <a class="dropdown-item" href="#"><i class="ri-printer-fill mr-2"></i>Print</a>
                                    <a class="dropdown-item" href="#"><i class="ri-file-download-fill mr-2"></i>Download</a>
                                 </div>
                              </div>
                           </div>
                        </div>
                        <div class="iq-card-body">
                           <div class="table-responsive">
                              <table class="table mb-0 table-borderless">
                                 <thead>
                                    <tr>
                                       <th scope="col">Conducteur</th>
                                       <th scope="col">Véhicule</th>
                                       <th scope="col">Date de début</th>
                                       <th scope="col" class="text-center">Status</th>
                                    </tr>
                                 </thead>
                                 <tbody>
                                    {% for deplacement in deplacements_recents %}
                                        <tr>
                                            <td>{{ deplacement.conducteur }}</td>
                                            <td>{{ deplacement.vehicule }}</td>
                                            <td>{{ deplacement.date_depart }}</td>
                                            <td class="text-center">
                                                {% if deplacement.date_depart > now  %}
                                                <div class="badge badge-pill iq-bg-danger">
                                                    En attente
                                                </div>
                                                {% elif deplacement.date_depart <= now %}
                                                <div class="badge badge-pill iq-bg-warning">
                                                    En cours
                                                </div>
                                                {% else %}
                                                <div class="badge badge-pill iq-bg-success">
                                                    Terminé
                                                </div>
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                 </tbody>
                              </table>
                           </div>
                        </div>
                     </div>
                  </div>
                  <div class="col-lg-4">
                     <div class="iq-card iq-card-block iq-card-stretch iq-card-height" id="weather">
                        <div class="iq-card-header d-flex justify-content-between">
                           <div class="iq-header-title">
                              <h4 class="card-title">Informations météo</h4>
                           </div>
                           <div class="iq-card-header-toolbar d-flex align-items-center">
                              <div class="dropdown">
                                 <span class="dropdown-toggle" id="dropdownMenuButton1" data-toggle="dropdown" >
                                 <i class="ri-more-fill"></i>
                                 </span>
                              </div>
                           </div>
                        </div>
                        <div class="iq-card-body">
                          <div id="weather-info">
                              <input type="text" id="cityInput" placeholder="Entrez une ville" class="form-control">
                              <button class="btn btn-primary mt-2 mb-3" id="btnMeteo">Obtenir la météo</button>
                            <h5 id="weather-city"></h5>
                            <h5 id="weather-description" class="text-capitalize"></h5>
                            <h5 id="temperature" class="text-danger"></h5>
                          </div>
                        </div>
                     </div>
                  </div>
               </div>
               <div class="row">
                  <div class="col-lg-12 row m-0 p-0">
                     <div class="col-md-12">
                        <div class="iq-card iq-card-block iq-card-stretch ">
                           <div class="iq-card-header d-flex justify-content-between">
                              <div class="iq-header-title">
                                 <h4 class="card-title">Calendrier des déplacements</h4>
                              </div>
                              <div class="iq-card-header-toolbar d-flex align-items-center">
                                 <div class="dropdown">
                                    <span class="dropdown-toggle" id="dropdownMenuButton-one" data-toggle="dropdown" >
                                    <i class="ri-more-fill"></i>
                                    </span>
                                    <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenuButton-one" style="">
                                       <a class="dropdown-item" href="#"><i class="ri-eye-fill mr-2"></i>View</a>
                                       <a class="dropdown-item" href="#"><i class="ri-delete-bin-6-fill mr-2"></i>Delete</a>
                                       <a class="dropdown-item" href="#"><i class="ri-pencil-fill mr-2"></i>Edit</a>
                                       <a class="dropdown-item" href="#"><i class="ri-printer-fill mr-2"></i>Print</a>
                                       <a class="dropdown-item" href="#"><i class="ri-file-download-fill mr-2"></i>Download</a>
                                    </div>
                                 </div>
                              </div>
                           </div>
                           <div class="iq-card-body">
{#                              <div id="home-chart-01"></div>#}
                               <div id="calendrier"></div>
                           </div>
                        </div>
                     </div>
                  </div>
               </div>
                 
            </div>

         </div>

      </div>



      <!-- Wrapper END -->
      <!-- Footer -->

{% include 'footer.html' %}
      <!-- Footer END -->
      <!-- Optional JavaScript -->
      <!-- jQuery first, then Popper.js, then Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script>
   function loadVehicules(page) {
      $.ajax({
         url: location.href,
         data: { page: page },
         dataType: 'html',
         success: function (data) {
            const $data = $(data);
            $('#vehicules-table').html($data.find('#vehicules-table').html());
            $('#pagination-links').html($data.find('#pagination-links').html());
         }
      });
   }

   $(document).on('click', '.pagination a', function (e) {
      e.preventDefault();
      const page = $(this).attr('data-page');
      loadVehicules(page);
   });

   // Chargement initial des véhicules
   loadVehicules(1);
</script>



    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/fullcalendar.min.css" />
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/fullcalendar.min.js"></script>
<script>
   $(document).ready(function () {
      $('#calendrier').fullCalendar({
         header: {
            left: 'prev,next today',
            center: 'title',
            right: 'month,agendaWeek'
         },
            height: 500,
         events: [
            {% for deplacement in deplacements_planifies %}
               {
                  title: '{{ deplacement.conducteur }} - {{ deplacement.vehicule }}',
                  start: '{{ deplacement.date_depart|date:"Y-m-d" }}T{{ deplacement.heure_depart|date:"H:i:s" }}',
                  end: '{{ deplacement.date_arrivee|date:"Y-m-d" }}T{{ deplacement.heure_arrivee|date:"H:i:s" }}'
               },
            {% endfor %}
         ],
         eventClick: function (event) {
            // Gérer le clic sur un événement
            alert('Clic sur l\'événement : ' + event.title);
         }
      });
   });
</script>

<script>
    function recupererMeteo(ville) {
            const apiKey = "{{api_key}}";
            {#const city = "Abidjan";#}
            const apiUrl = `https://api.openweathermap.org/data/2.5/weather?q=${ville}&appid=${apiKey}&units=metric&lang=fr`;

            $.ajax({
              url: apiUrl,
              type: 'GET',
              dataType: 'json',
              success: (data) => {
                  $('#weather-info');
                  $('#weather-city').text(`Ville : ${data.name}`);
                  $('#weather-description').text(`Conditions météo : ${data.weather[0].description}`);
                  $('#temperature').text(`Température : ${data.main.temp} °C`);

                console.log(data);
              },
              error: () => {
                alert('Merci de revenir plus tard.');
              }
            });
    }

    recupererMeteo('Paris');

    $('#btnMeteo').on('click', ()=>{
        let villeChoisie = $('#cityInput').val();
         recupererMeteo(villeChoisie);
    })
</script>

</body>

{% endblock %}